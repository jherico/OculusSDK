# Derived from the auto-created makefiles generated by Eclipse CDT 
# TODO add debug / release switch

SOURCE_DIR := ../../Src
BUILD_DIR := ../../Lib/Linux/Debug
ARTIFACT := ${BUILD_DIR}/libOculus.so

RM := rm -rf

# Grab all the source files
ALL_SRCS := $(shell find ${SOURCE_DIR} -name *.cpp)

# Filter out Windows and OSX files
CPP_SRCS := $(filter-out \
	${SOURCE_DIR}/OVR_Win32%.cpp \
	${SOURCE_DIR}/OVR_OSX%.cpp \
	${SOURCE_DIR}/Kernel/OVR_ThreadsWinAPI.cpp \
	, $(ALL_SRCS))

# Derive the output object names and dependency names from the source files
OBJS := $(patsubst ${SOURCE_DIR}/%.cpp, ${BUILD_DIR}/%.o, ${CPP_SRCS})
CPP_DEPS := $(patsubst ${SOURCE_DIR}/%.cpp, ${BUILD_DIR}/%.d, ${CPP_SRCS})

# Rule for building objects and dependency files.  
${BUILD_DIR}/%.o: ${SOURCE_DIR}/%.cpp
	@echo 'Building file: $<'
	@echo 'Invoking: GCC C++ Compiler'
	g++ -O0 -g3 -Wall -c -fmessage-length=0 -fPIC -MMD -MP -MF"$(@:%.o=%.d)" -MT"$(@:%.o=%.d)" -o "$@" "$<"
	@echo 'Finished building: $<'
	@echo ' '

# All Target
all: ${ARTIFACT}

# Tool invocations
${ARTIFACT}: ${BUILD_DIR} ${BUILD_DIR}/Kernel ${BUILD_DIR}/Util $(OBJS) $(USER_OBJS)
	@echo 'Building target: $@'
	@echo 'Invoking: GCC C++ Linker'
	g++ -shared -o "${BUILD_DIR}/libOculus.so" $(OBJS) $(USER_OBJS) $(LIBS)
	@echo 'Finished building target: $@'
	@echo ' '

${BUILD_DIR}:
	mkdir -p $@

${BUILD_DIR}/Kernel:
	mkdir -p $@

${BUILD_DIR}/Util:
	mkdir -p $@

# Other Targets
clean:
	-$(RM) $(OBJS)$(C++_DEPS)$(C_DEPS)$(CC_DEPS)$(LIBRARIES)$(CPP_DEPS)$(CXX_DEPS)$(C_UPPER_DEPS) Lib/Linux/Debug/libOculus.so
	-@echo ' '

.PHONY: all clean dependents
